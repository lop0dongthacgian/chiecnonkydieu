<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi·∫øc N√≥n K·ª≥ Di·ªáu - Family & Friends</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Fireworks CSS - Phi√™n b·∫£n c·∫£i ti·∫øn */
    .fireworks {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none; /* Cho ph√©p click xuy√™n qua l·ªõp ph√°o hoa */
      z-index: 9999;
      overflow: hidden;
      background: transparent;
    }

    .firework {
      position: absolute;
      width: 5px; /* Chi·ªÅu r·ªông c·ªßa v·ªát ph√°o hoa */
      height: 5px; /* Chi·ªÅu cao c·ªßa v·ªát ph√°o hoa */
      border-radius: 50%;
      opacity: 0; /* B·∫Øt ƒë·∫ßu v·ªõi tr·∫°ng th√°i trong su·ªët */
      /* S·ª≠ d·ª•ng animation m·ªõi:
        - `fireworks-animation`: T√™n animation.
        - `1.2s`: Th·ªùi gian ch·∫°y animation.
        - `ease-out`: B·∫Øt ƒë·∫ßu nhanh v√† ch·∫≠m d·∫ßn v·ªÅ cu·ªëi.
        - `forwards`: Gi·ªØ l·∫°i tr·∫°ng th√°i cu·ªëi c√πng c·ªßa animation (bi·∫øn m·∫•t).
      */
      animation: fireworks-animation 1.2s ease-out forwards;
    }

    @keyframes fireworks-animation {
      0% {
        /* B·∫Øt ƒë·∫ßu:
          - Hi·ªán r√µ, k√≠ch th∆∞·ªõc nh·ªè.
          - Di chuy·ªÉn l√™n tr√™n m·ªôt ch√∫t ƒë·ªÉ t·∫°o l·ª±c ƒë·∫©y ban ƒë·∫ßu.
        */
        opacity: 1;
        transform: translateY(0) scale(1);
        box-shadow: 0 0 5px #fff, 0 0 10px #ff0, 0 0 15px #f0c;
      }
      50% {
        /*
          Gi·ªØa ch·ª´ng:
          - V·∫´n c√≤n s√°ng r√µ.
          - K√≠ch th∆∞·ªõc l·ªõn nh·∫•t.
        */
        opacity: 0.8;
        transform: translateY(-80px) scale(1.5);
      }
      100% {
        /*
          K·∫øt th√∫c:
          - Ho√†n to√†n trong su·ªët (bi·∫øn m·∫•t).
          - Di chuy·ªÉn xu·ªëng d∆∞·ªõi (hi·ªáu ·ª©ng r∆°i) v√† co l·∫°i.
          - √Ånh s√°ng m·ªù ƒëi.
        */
        opacity: 0;
        transform: translateY(40px) scale(0.8);
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div id="splashScreen">
    <div class="splash-content">
        <h1>Chi·∫øc N√≥n K·ª≥ Di·ªáu</h1>
        <p class="intro">üß© Tr√≤ ch∆°i ƒëo√°n ch·ªØ "Chi·∫øc n√≥n k·ª≥ di·ªáu" v·ªën r·∫•t ƒë∆∞·ª£c m·ªçi ng∆∞·ªùi y√™u th√≠ch, nay ƒë√£ ƒë∆∞·ª£c <span class="highlight-creator">L·ªõp h·ªçc 0 ƒë·ªìng</span> ph√°t tri·ªÉn th√†nh phi√™n b·∫£n luy·ªán t·ª´ v·ª±ng ti·∫øng Anh d√†nh cho c√°c em nh·ªè! üá¨üáßüìö</p>
        <div class="details">
            <h2>üìù N·ªôi dung:</h2>
            <ul>
                <li>üîπ G·ªìm 150 c√¢u h·ªèi ti·∫øng Anh</li>
                <li>üîπ D·ª±a theo gi√°o tr√¨nh <span class="highlight-program">Family and Friends</span></li>
                <li>üîπ C√¢u h·ªèi s·∫Ω thay ƒë·ªïi <span class="highlight-update">ƒë·ªãnh k·ª≥</span> ƒë·ªÉ lu√¥n m·ªõi m·∫ª v√† h·∫•p d·∫´n!</li>
            </ul>
        </div>
        <p class="outro">üéÆ Tr√≤ ch∆°i kh√¥ng ch·ªâ gi√∫p c√°c ch√°u trong l·ªõp √¥n luy·ªán m√† c√≤n ph√π h·ª£p cho m·ªçi h·ªçc sinh ƒëang h·ªçc ti·∫øng Anh, gi√∫p c√°c em <span class="highlight-benefit">v·ª´a h·ªçc v·ª´a ch∆°i ‚Äì vui h√® b·ªï √≠ch!</span> üåà</p>
    </div>
    <div class="splash-buttons">
      <button id="playInstructionsButton">M·ªü √¢m thanh h∆∞·ªõng d·∫´n</button>
      <button id="startGameButton">V√†o tr√≤ ch∆°i</button>
    </div>
  </div>

  <div class="game-wrapper" id="gameWrapper">
    <header>
      <h1>Chi·∫øc N√≥n K·ª≥ Di·ªáu</h1>
    </header>

    <div class="main-content">
      <div class="right-panel">
        <div id="players">
          <div class="player active" id="player1">
            <h3>Ng∆∞·ªùi Ch∆°i</h3>
            <p>ƒêi·ªÉm: <span id="score1">0</span></p>
          </div>
        </div>

        <div id="guessInputContainer">
          <label for="guessLetter" id="guessInputLabel"><strong>Nh·∫≠p k√Ω t·ª±:</strong></label>
          <input type="text" id="guessLetter" maxlength="1" autofocus/>
          <div class="guess-buttons">
            <button onclick="submitGuess()">ƒêO√ÅN</button>
            <button id="buyLetterButton" onclick="buyLetter()">MUA CH·ªÆ (500ƒë)</button>
          </div>
        </div>
      </div>

      <div class="left-panel">
        <div id="question"></div>
        <div class="answer-container" id="answerContainer"></div>

        <div id="wheel-container">
          <div id="wheel"></div>
          <button id="spinButton" onclick="spinWheel()">QUAY</button>
          <div id="resultOverlay"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="gameNotification" class="info"></div>
  <div id="winOverlay"></div>

  <button id="musicToggle" class="paused">M·ªü nh·∫°c</button>

  <footer>
    <p>&copy; 2025 - L·ªõp h·ªçc 0 ƒë·ªìng Trung B√¨nh A3</p>
  </footer>

  <audio id="backgroundMusic" loop>
    <source src="nhacnen.mp3" type="audio/mpeg">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph·∫ßn t·ª≠ audio.
  </audio>
  <audio id="instructionAudio">
    <source src="audio/hd.mp3" type="audio/mpeg">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph·∫ßn t·ª≠ audio.
  </audio>


  <script src="questions.js"></script>
  <script>
    // ƒê·ªãnh nghƒ©a c√°c ph√¢n ƒëo·∫°n b√°nh xe g·ªëc
    const originalSegments = [
      { text: "100", color: "#FFD700" }, // V√†ng (Gold)
      { text: "200", color: "#FF6347" }, // ƒê·ªè c√† chua (Tomato)
      { text: "300", color: "#6A5ACD" }, // Xanh t√≠m (SlateBlue)
      { text: "400", color: "#32CD32" }, // Xanh l√° chanh (LimeGreen)
      { text: "500", color: "#1E90FF" }, // Xanh d∆∞∆°ng ƒë·∫≠m (DodgerBlue)
      { text: "600", color: "#FF1493" }, // H·ªìng ƒë·∫≠m (DeepPink)
      { text: "700", color: "#BA55D3" }, // T√≠m nh·∫°t (MediumOrchid)
      { text: "800", color: "#00CED1" }, // Xanh ng·ªçc lam (DarkTurquoise)
      { text: "900", color: "#FFA500" }, // Cam (Orange)
      { text: "1000", color: "#8B008B" }, // T√≠m ƒë·∫≠m (DarkMagenta)
      { text: "May m·∫Øn", color: "#ADFF2F" }, // Xanh l√° c√¢y v√†ng (GreenYellow)
      { text: "Nh√¢n ƒë√¥i", color: "#FFFF00" },  // V√†ng tinh khi·∫øt (Yellow)
      { text: "ƒêo√°n ch·ªØ", color: "#FF4500" } // Cam ƒë·ªè (OrangeRed)
    ];

    const wheel = document.getElementById("wheel");
    const resultOverlay = document.getElementById("resultOverlay");
    const questionElement = document.getElementById("question");
    const answerContainer = document.getElementById("answerContainer");
    const guessInputContainer = document.getElementById("guessInputContainer");
    const guessInput = document.getElementById("guessLetter");
    const guessInputLabel = document.getElementById("guessInputLabel");
    const guessSubmitBtn = document.querySelector("#guessInputContainer .guess-buttons button:first-child");
    const buyLetterButton = document.getElementById("buyLetterButton");

    const gameNotification = document.getElementById("gameNotification");
    const winOverlay = document.getElementById('winOverlay'); // L·∫•y div t·ª´ HTML

    const backgroundMusic = document.getElementById("backgroundMusic");
    const musicToggleBtn = document.getElementById("musicToggle");

    // Splash Screen elements
    const splashScreen = document.getElementById('splashScreen');
    const startGameButton = document.getElementById('startGameButton');
    const playInstructionsButton = document.getElementById('playInstructionsButton');
    const instructionAudio = document.getElementById('instructionAudio');
    const gameWrapper = document.getElementById('gameWrapper');


    let currentQuestion;
    let answer;
    let plainAnswer;
    let revealedLetters;
    
    let currentPlayer = 1;
    let currentSpinValue = null;
    let scores = [0];
    let currentAngle = 0;
    let spinning = false;

    let isGuessingLetter = false;
    let isGuessingFullAnswer = false;

    let availableQuestionIndices = [];
    let askedQuestionIndices = [];

    let isMusicPlaying = false; 
    let hasUserInteracted = false; 


    // --- Audio Playback Functions ---
    function playNotificationSound(filename) {
        const audio = new Audio(`audio/${filename}`);
        audio.play().catch(e => {
            console.warn(`Error playing sound ${filename}:`, e);
        });
    }

    // --- Splash Screen Logic ---
    playInstructionsButton.addEventListener('click', () => {
        if (!instructionAudio.paused) {
            instructionAudio.pause();
            instructionAudio.currentTime = 0;
            playInstructionsButton.textContent = "M·ªü √¢m thanh h∆∞·ªõng d·∫´n";
        } else {
            instructionAudio.play().then(() => {
                playInstructionsButton.textContent = "T·∫Øt √¢m thanh h∆∞·ªõng d·∫´n";
            }).catch(e => {
                console.warn("L·ªói khi ph√°t h∆∞·ªõng d·∫´n:", e);
            });
        }
    });

    startGameButton.addEventListener('click', () => {
        if (!instructionAudio.paused) {
            instructionAudio.pause();
            instructionAudio.currentTime = 0;
        }

        splashScreen.classList.add('hidden'); 
        
        splashScreen.addEventListener('transitionend', function handler() {
            splashScreen.removeEventListener('transitionend', handler);
            gameWrapper.style.display = 'flex'; 
            setTimeout(() => {
                gameWrapper.classList.add('visible');
            }, 50); 

            backgroundMusic.volume = 0.5;
            backgroundMusic.play().then(() => {
                isMusicPlaying = true;
                musicToggleBtn.classList.remove('paused');
                musicToggleBtn.classList.add('playing');
                musicToggleBtn.textContent = 'T·∫Øt nh·∫°c';
            }).catch(e => {
                console.warn("L·ªói khi ph√°t nh·∫°c n·ªÅn:", e);
                showNotification("Tr√¨nh duy·ªát ch·∫∑n t·ª± ƒë·ªông ph√°t nh·∫°c n·ªÅn. Vui l√≤ng nh·∫•n 'M·ªü nh·∫°c' ƒë·ªÉ b·∫≠t.", 5000, 'warning');
            });

            initializeGame();
        }, { once: true });
    });


    // --- Ch·ª©c nƒÉng nh·∫°c n·ªÅn ---
    function toggleMusic() {
        if (isMusicPlaying) {
            backgroundMusic.pause();
            musicToggleBtn.classList.remove('playing');
            musicToggleBtn.classList.add('paused');
            musicToggleBtn.textContent = 'M·ªü nh·∫°c';
            isMusicPlaying = false;
        } else {
            backgroundMusic.play().then(() => {
                isMusicPlaying = true;
                musicToggleBtn.classList.remove('paused');
                musicToggleBtn.classList.add('playing');
                musicToggleBtn.textContent = 'T·∫Øt nh·∫°c';
            }).catch(e => {
                console.warn("L·ªói khi c·ªë g·∫Øng ph√°t nh·∫°c qua n√∫t:", e);
                showNotification("Kh√¥ng th·ªÉ ph√°t nh·∫°c. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát.", 5000, 'error', 'tb2.wav');
            });
        }
    }

    musicToggleBtn.addEventListener('click', toggleMusic);

    function showNotification(message, duration = 3000, type = 'info', audioFilename = null) {
      if (gameNotification.timeoutId) clearTimeout(gameNotification.timeoutId);
      gameNotification.textContent = message;
      gameNotification.className = `info ${type}`;
      gameNotification.classList.add('show');
      if (audioFilename) playNotificationSound(audioFilename);
      gameNotification.timeoutId = setTimeout(() => {
        gameNotification.classList.remove('show');
        gameNotification.addEventListener('transitionend', function handler() {
          gameNotification.className = 'info';
          gameNotification.removeEventListener('transitionend', handler);
        }, { once: true });
      }, duration);
    }

    function showWinOverlay(message, duration = 4000, audioFilename = null) {
      winOverlay.textContent = message;
      winOverlay.style.display = 'flex';
      winOverlay.style.opacity = '1';
      winOverlay.style.transform = 'translate(-50%, -50%) scale(1)';
      if (audioFilename) playNotificationSound(audioFilename);

      // Hi·ªáu ·ª©ng ph√°o hoa
      showFireworks();

      setTimeout(() => {
        winOverlay.style.opacity = '0';
        winOverlay.style.transform = 'translate(-50%, -50%) scale(0.8)';
        winOverlay.addEventListener('transitionend', function handler() {
          winOverlay.style.display = 'none';
          winOverlay.removeEventListener('transitionend', handler);
        }, { once: true });
      }, duration);
    }

    function showFireworks(count = 30) {
      const fireworksContainer = document.createElement("div");
      fireworksContainer.classList.add("fireworks");
      document.body.appendChild(fireworksContainer);

      for (let i = 0; i < count; i++) {
        const firework = document.createElement("div");
        firework.classList.add("firework");
        firework.style.left = `${Math.random() * 100}vw`;
        firework.style.top = `${Math.random() * 100}vh`;
        firework.style.animationDelay = `${Math.random() * 1.2}s`; // Ng·∫´u nhi√™n h√≥a th·ªùi gian b·∫Øt ƒë·∫ßu
        firework.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`; // M√†u s·∫Øc ng·∫´u nhi√™n
        fireworksContainer.appendChild(firework);
      }

      // X√≥a container ph√°o hoa sau khi hi·ªáu ·ª©ng k·∫øt th√∫c
      setTimeout(() => fireworksContainer.remove(), 2500);
    }

    function getRandomQuestionIndex() {
      if (availableQuestionIndices.length === 0) {
        if (allQuestions.length > 0) {
          showNotification("Th√¥ng b√°o 1: B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!", 3000, 'info', 'tb3.wav');
          setTimeout(() => {
            showNotification("Th√¥ng b√°o 2: H·ªá th·ªëng s·∫Ω b·∫Øt ƒë·∫ßu l·∫°i b·ªô c√¢u h·ªèi.", 3000, 'info', 'tb4.wav');
          }, 1000);
          setTimeout(() => {
            showNotification("Th√¥ng b√°o 3: Ch√∫c b·∫°n ti·∫øp t·ª•c ch∆°i vui v·∫ª!", 3000, 'success');
          }, 2000);

          for (let i = 0; i < allQuestions.length; i++) {
            availableQuestionIndices.push(i);
          }
          askedQuestionIndices = [];
        } else {
          return -1;
        }
      }

      const randomIndex = Math.floor(Math.random() * availableQuestionIndices.length);
      const questionActualIndex = availableQuestionIndices.splice(randomIndex, 1)[0];
      askedQuestionIndices.push(questionActualIndex);
      return questionActualIndex;
    }

    function initializeGame() {
      if (availableQuestionIndices.length === 0 && askedQuestionIndices.length === 0) {
          for (let i = 0; i < allQuestions.length; i++) {
              availableQuestionIndices.push(i);
          }
      }

      const nextQuestionActualIndex = getRandomQuestionIndex();

      if (nextQuestionActualIndex === -1) {
        endGame();
        return;
      }

      currentQuestion = allQuestions[nextQuestionActualIndex];
      answer = currentQuestion.answer;
      plainAnswer = currentQuestion.plainAnswer;
      revealedLetters = Array(answer.length).fill(null);

      answer.forEach((char, index) => {
        if (char === " ") {
          revealedLetters[index] = char;
        }
      });

      questionElement.innerHTML = `<strong>C√¢u h·ªèi (${askedQuestionIndices.length}/${allQuestions.length}):</strong> ${currentQuestion.question}`;
      renderAnswerBoxes();
      renderWheelSegments(); // V·∫Ω l·∫°i b√°nh xe, kh√¥ng c·∫ßn reset v√¨ n√≥ kh√¥ng ƒë·ªïi
      updateScores();
      document.getElementById("spinButton").disabled = false;
      guessInputContainer.style.display = "none";
      resultOverlay.style.display = "none";

      document.getElementById("player1").classList.add("active");
      showNotification(`B·∫Øt ƒë·∫ßu c√¢u h·ªèi m·ªõi! M·ªùi b·∫°n nh·∫•n n√∫t quay.`, 3000, 'info', 'tb4.wav');
      updateBuyLetterButtonState();
    }

    function renderAnswerBoxes() {
      answerContainer.innerHTML = '';
      let currentGroup = document.createElement("div");
      currentGroup.className = "answer-group";

      answer.forEach((char, index) => {
        if (char === " ") {
          answerContainer.appendChild(currentGroup);
          const spaceDiv = document.createElement("div");
          spaceDiv.className = "word-space";
          answerContainer.appendChild(spaceDiv);
          currentGroup = document.createElement("div");
          currentGroup.className = "answer-group";
        } else {
          const box = document.createElement("div");
          box.className = "letter-box";
          box.id = `box-${index}`;
          box.innerText = revealedLetters[index] || '';
          if (revealedLetters[index] !== null && revealedLetters[index] !== " ") {
            box.classList.add("revealed");
          }
          currentGroup.appendChild(box);
        }
      });
      if (currentGroup.children.length > 0) {
        answerContainer.appendChild(currentGroup);
      }
    }

    function renderWheelSegments() {
      wheel.innerHTML = '';
      const numSegments = originalSegments.length;
      const anglePerSegment = 360 / numSegments;

      originalSegments.forEach((seg, i) => {
        const segmentDiv = document.createElement("div");
        segmentDiv.className = "segment";
        segmentDiv.style.backgroundColor = seg.color;
        
        const skewYValue = 90 - (anglePerSegment / 2);
        segmentDiv.style.transform = `rotate(${i * anglePerSegment}deg) skewY(${skewYValue}deg)`;
        segmentDiv.style.clipPath = `polygon(0% 0%, 100% 50%, 0% 100%)`;

        const textSpan = document.createElement("span");
        textSpan.innerText = seg.text;
        textSpan.style.transform = `skewY(-${skewYValue}deg) rotate(${anglePerSegment / 2}deg)`;
        segmentDiv.appendChild(textSpan);
        wheel.appendChild(segmentDiv);
      });
    }

    function spinWheel() {
      if (spinning) return;
      spinning = true;
      document.getElementById("spinButton").disabled = true;
      guessInput.disabled = true;
      guessSubmitBtn.disabled = true;
      buyLetterButton.disabled = true;

      resultOverlay.style.display = "none";
      guessInputContainer.style.display = "none";

      const spinDegree = 3600 + Math.floor(Math.random() * 360);
      currentAngle += spinDegree;
      wheel.style.transition = "transform 5s cubic-bezier(0.33, 1, 0.68, 1)";
      wheel.style.transform = `rotate(${currentAngle}deg)`;

      setTimeout(() => {
        const finalAngle = currentAngle % 360;
        const numSegments = originalSegments.length;
        let index = Math.floor((360 - (finalAngle % 360) + (360 / numSegments / 2)) / (360 / numSegments)) % numSegments;
        const result = originalSegments[index].text;

        resultOverlay.style.background = originalSegments[index].color;
        resultOverlay.style.display = "block";

        if (!isNaN(parseInt(result))) {
          resultOverlay.innerText = `+${result} ƒëi·ªÉm!`;
          currentSpinValue = parseInt(result);
          isGuessingLetter = true;
          isGuessingFullAnswer = false;
          updateGuessInputVisibility();
          showNotification(`B·∫°n quay ƒë∆∞·ª£c ${result} ƒëi·ªÉm! M·ªùi ƒëo√°n m·ªôt ch·ªØ c√°i.`, 3000, 'info', 'tb23.wav');
        } else if (result === "Nh√¢n ƒë√¥i") {
          resultOverlay.innerText = `NH√ÇN ƒê√îI ƒêI·ªÇM!`;
          currentSpinValue = "double";
          isGuessingLetter = true;
          isGuessingFullAnswer = false;
          updateGuessInputVisibility();
          showNotification(`K·∫øt qu·∫£: Nh√¢n ƒë√¥i! Nh·∫≠p ch·ªØ c√°i b·∫°n mu·ªën ƒëo√°n.`, 3000, 'info', 'tb7.wav');
        } else if (result === "ƒêo√°n ch·ªØ") {
          resultOverlay.innerText = `ƒêO√ÅN C·∫¢ √î CH·ªÆ!`;
          isGuessingLetter = false;
          isGuessingFullAnswer = true;
          currentSpinValue = null;
          updateGuessInputVisibility();
          showNotification(`K·∫øt qu·∫£: ƒêo√°n ch·ªØ! Nh·∫≠p to√†n b·ªô ƒë√°p √°n.`, 3000, 'info', 'tb8.wav');
        } else if (result === "May m·∫Øn") {
            resultOverlay.innerText = `√î MAY M·∫ÆN!`;
            currentSpinValue = null;
            isGuessingLetter = false;
            isGuessingFullAnswer = false;
            revealRandomLetter();
            scores[0] += 300;
            updateScores();
            showNotification(`Ch√∫c m·ª´ng b·∫°n quay tr√∫ng √¥: May m·∫Øn! M·ªôt ch·ªØ c√°i ƒë√£ ƒë∆∞·ª£c nh·∫≠p v√† 300 ƒëi·ªÉm ƒë√£ ƒë∆∞·ª£c c·ªông.`, 3000, 'success', 'tb9.wav');
            document.getElementById("spinButton").disabled = false;
            guessInputContainer.style.display = "none";
            setTimeout(() => { resultOverlay.style.display = "none"; }, 5000);
            updateBuyLetterButtonState();
        } else {
          resultOverlay.innerText = result;
          currentSpinValue = null;
          isGuessingLetter = false;
          isGuessingFullAnswer = false;
          showNotification(`K·∫øt qu·∫£ kh√¥ng x√°c ƒë·ªãnh: ${result}. Vui l√≤ng quay l·∫°i.`, 3000, 'warning', 'tb10.wav');
          document.getElementById("spinButton").disabled = false;
          guessInputContainer.style.display = "none";
          setTimeout(() => { resultOverlay.style.display = "none"; }, 5000);
        }

        spinning = false;

        if (isGuessingLetter || isGuessingFullAnswer) {
            guessInput.disabled = false;
            guessSubmitBtn.disabled = false;
            guessInput.focus();
            setTimeout(() => { resultOverlay.style.display = "none"; }, 5000);
        } else {
            document.getElementById("spinButton").disabled = false;
            updateBuyLetterButtonState();
        }

      }, 5000);
    }

    function updateGuessInputVisibility() {
      guessInputContainer.style.display = "block";
      guessInput.value = "";
      guessInput.focus();
      updateBuyLetterButtonState();

      if (isGuessingLetter) {
        guessInputLabel.innerText = "Nh·∫≠p k√Ω t·ª± (m·ªôt ch·ªØ c√°i):";
        guessInput.maxLength = "1";
        guessInput.placeholder = "Nh·∫≠p ch·ªØ";
        guessSubmitBtn.innerText = "ƒêO√ÅN CH·ªÆ";
        guessSubmitBtn.style.display = "inline-block";
      } else if (isGuessingFullAnswer) {
        guessInputLabel.innerText = "Nh·∫≠p to√†n b·ªô ƒë√°p √°n:";
        guessInput.removeAttribute("maxlength");
        guessInput.placeholder = "Nh·∫≠p to√†n b·ªô ƒë√°p √°n...";
        guessSubmitBtn.innerText = "ƒêO√ÅN TO√ÄN B·ªò";
        guessSubmitBtn.style.display = "inline-block";
      } else {
        guessInputContainer.style.display = "none";
        guessSubmitBtn.style.display = "none";
      }
    }

    function revealRandomLetter() {
        const hiddenIndices = [];
        for (let i = 0; i < revealedLetters.length; i++) {
            if (answer[i] !== " " && revealedLetters[i] === null) {
                hiddenIndices.push(i);
            }
        }

        if (hiddenIndices.length > 0) {
            const randomIndex = hiddenIndices[Math.floor(Math.random() * hiddenIndices.length)];
            revealedLetters[randomIndex] = answer[randomIndex];
            const box = document.getElementById(`box-${randomIndex}`);
            if (box) {
                box.innerText = answer[randomIndex];
                box.classList.add("revealed");
            }
            checkGameCompletion();
            return true;
        } else {
            showNotification("Kh√¥ng c√≤n ch·ªØ c√°i n√†o ƒë·ªÉ nh√¢p. ƒê√°p √°n ƒë√£ ƒë∆∞·ª£c m·ªü h·∫øt.", 3000, 'info', 'tb18.wav');
            return false;
        }
    }

    function buyLetter() {
        const COST_OF_LETTER = 500;
        if (scores[0] < COST_OF_LETTER) {
            showNotification(`B·∫°n kh√¥ng ƒë·ªß ${COST_OF_LETTER} ƒëi·ªÉm ƒë·ªÉ mua ch·ªØ.`, 3000, 'error', 'tb19.wav');
            return;
        }

        const letterRevealed = revealRandomLetter();

        if (letterRevealed) {
            scores[0] -= COST_OF_LETTER; 
            updateScores();
            showNotification(`B·∫°n ƒë√£ mua m·ªôt ch·ªØ v·ªõi gi√° -${COST_OF_LETTER} ƒëi·ªÉm!`, 3000, 'success', 'tb20.wav');
            guessInputContainer.style.display = "none";
            document.getElementById("spinButton").disabled = false; 
            updateBuyLetterButtonState();
        }
    }

    function updateBuyLetterButtonState() {
        const hiddenLettersCount = revealedLetters.filter(l => l === null && l !== " ").length;
        if (scores[0] < 500 || hiddenLettersCount === 0) {
            buyLetterButton.disabled = true;
            buyLetterButton.classList.add('disabled');
        } else {
            buyLetterButton.disabled = false;
            buyLetterButton.classList.remove('disabled');
        }
    }

    function submitGuess() {
      const guess = guessInput.value.toUpperCase().trim();
      if (!guess) {
        showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung b·∫°n ƒë√£ ƒëo√°n.', 3000, 'warning', 'tb11.wav');
        return;
      }

      if (isGuessingLetter) {
        if (guess.length !== 1) {
            showNotification('Vui l√≤ng ch·ªâ nh·∫≠p 1 k√Ω t·ª± ƒë·ªÉ ƒëo√°n ch·ªØ c√°i.', 3000, 'warning', 'tb12.wav');
            return;
        }
        processLetterGuess(guess);
      } else if (isGuessingFullAnswer) {
        processFullAnswerGuess(guess);
      }
      
      guessInputContainer.style.display = "none";
      document.getElementById("spinButton").disabled = false;
      guessInput.disabled = false;
      guessSubmitBtn.disabled = false;
      updateBuyLetterButtonState();
    }

    function processLetterGuess(letter) {
      const inputPlain = letter.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      let matched = 0;
      
      for (let i = 0; i < plainAnswer.length; i++) {
        if (plainAnswer[i] === inputPlain && revealedLetters[i] === null) {
          revealedLetters[i] = answer[i];
          document.getElementById(`box-${i}`).innerText = answer[i];
          document.getElementById(`box-${i}`).classList.add("revealed");
          matched++;
        }
      }

      if (matched > 0) {
        let earned = 0;
        if (currentSpinValue === "double") {
          earned = matched * 2 * 200;
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng ${matched} ch·ªØ. ƒê∆∞·ª£c x2 ƒëi·ªÉm, nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success', 'tb13.wav');
        } else {
          earned = matched * currentSpinValue;
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng ${matched} ch·ªØ. Nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success', 'tb14.wav');
        }
        scores[0] += earned;
      } else {
        scores[0] -= 300; 
        showNotification(`Sai r·ªìi! B·∫°n ƒëo√°n ch·ªØ '${letter}' kh√¥ng c√≥ ho·∫∑c ƒë√£ m·ªü. B·ªã tr·ª´ 300 ƒëi·ªÉm.`, 3000, 'error', 'tb15.wav');
      }
      updateScores();
      isGuessingLetter = false;
      checkGameCompletion();
      document.getElementById("spinButton").disabled = false;
      guessInputContainer.style.display = "none";
    }

    function processFullAnswerGuess(guess) {
      const normalizedGuess = guess.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '');
      const normalizedCorrectAnswer = plainAnswer.filter(char => char !== " ").join("");

      if (normalizedGuess === normalizedCorrectAnswer) {
          const hiddenLettersCount = revealedLetters.filter(l => l === null).length;
          let earned = hiddenLettersCount * 100;
          scores[0] += earned;
          
          for (let i = 0; i < answer.length; i++) {
              if (revealedLetters[i] === null) {
                  revealedLetters[i] = answer[i];
                  const box = document.getElementById(`box-${i}`);
                  if (box) {
                    box.innerText = answer[i];
                    box.classList.add("revealed");
                  }
              }
          }
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng to√†n b·ªô ƒë√°p √°n. Nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success', 'tb16.wav');
          updateScores();
          checkGameCompletion();
      } else {
          scores[0] -= 300; 
          showNotification(`Sai r·ªìi! B·∫°n ƒëo√°n sai to√†n b·ªô ƒë√°p √°n. B·ªã tr·ª´ 300 ƒëi·ªÉm.`, 3000, 'error', 'tb17.wav');
      }
      updateScores();
      isGuessingFullAnswer = false;
      document.getElementById("spinButton").disabled = false;
      guessInputContainer.style.display = "none";
    }

    function updateScores() {
      document.getElementById("score1").innerText = scores[0];
      updateBuyLetterButtonState();
    }


    function checkGameCompletion() {
      const allLetterBoxesFilled = revealedLetters.every(char => char !== null && char !== " ");
      if (allLetterBoxesFilled) {
        showWinOverlay(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh c√¢u h·ªèi n√†y v·ªõi ${scores[0]} ƒëi·ªÉm!`, 4000, 'tb21.wav');
        setTimeout(() => {
          initializeGame();
        }, 4000);
      }
    }

    function endGame() {
      const finalScore = scores[0];
      
      document.getElementById("player1").classList.remove("active");
      document.querySelector("#player1 h3").innerText = "Tr√≤ ch∆°i k·∫øt th√∫c!";
      document.querySelector("#player1 p").innerText = "ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n: " + finalScore;
      
      document.getElementById("spinButton").disabled = true;
      guessInputContainer.style.display = "none";
      resultOverlay.style.display = "none";
      showNotification("Tr√≤ ch∆°i ƒë√£ k·∫øt th√∫c! T·ªïng ƒëi·ªÉm c·ªßa b·∫°n l√†: " + finalScore + ". C·∫£m ∆°n b·∫°n ƒë√£ tham gia.", 5000, 'info', 'tb22.wav');
      updateBuyLetterButtonState();
    }

  </script>
</body>
</html>
