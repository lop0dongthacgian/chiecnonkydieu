<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi·∫øc N√≥n K·ª≥ Di·ªáu</title>
  <style>
    :root {
      --primary-color: #d63384; /* M√†u ch·ªß ƒë·∫°o h·ªìng */
      --secondary-color: #4CAF50; /* M√†u xanh l√° cho ƒëi·ªÉm */
      --background-color: #f4f4f4;
      --card-bg-color: #ffffff;
      --border-color: #ddd;
      --text-color: #333;
      --dark-text-color: #555;
      --font-family: 'Arial', sans-serif;

      /* Colors for notifications */
      --info-bg-color: #2196F3; /* Blue */
      --info-text-color: white;
      --success-bg-color: #4CAF50; /* Green */
      --success-text-color: white;
      --error-bg-color: #f44336; /* Red */
      --error-text-color: white;
      --warning-bg-color: #ff9800; /* Orange */
      --warning-text-color: white;

      /* New color for music button */
      --music-button-color: #007bff; /* M√†u xanh d∆∞∆°ng cho n√∫t nh·∫°c */
      --music-button-hover-color: #0056b3; /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
    }

    body {
      font-family: var(--font-family);
      background-color: var(--background-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column; /* ƒê·∫∑t l·∫°i th√†nh c·ªôt ƒë·ªÉ footer n·∫±m d∆∞·ªõi */
      justify-content: center;
      align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
      min-height: 100vh;
      box-sizing: border-box;
      position: relative; /* Cho ph√©p notification v√† n√∫t nh·∫°c ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi */
    }

    .game-wrapper {
      display: flex;
      flex-direction: column; /* M·∫∑c ƒë·ªãnh c·ªôt cho m√†n h√¨nh nh·ªè */
      max-width: 1200px;
      width: 100%;
      background: var(--card-bg-color);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 20px; /* Th√™m kho·∫£ng c√°ch v·ªõi footer */
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      text-align: center;
      border-bottom: 5px solid #bf2a73;
      position: relative; /* ƒê·ªÉ ch·ª©a n√∫t nh·∫°c n·∫øu mu·ªën ƒë·∫∑t trong header */
    }

    header h1 {
      margin: 0;
      font-size: 2.5em;
      letter-spacing: 1px;
    }

    /* Music Button - New position: fixed to bottom right */
    #musicToggle {
        position: fixed; /* Gi·ªØ n√∫t lu√¥n hi·ªÉn th·ªã */
        bottom: 20px; /* V·ªã tr√≠ so v·ªõi ƒë√°y trang */
        right: 20px; /* V·ªã tr√≠ so v·ªõi l·ªÅ ph·∫£i */
        background-color: var(--music-button-color); /* M√†u xanh d∆∞∆°ng m·ªõi */
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1001; /* ƒê·∫£m b·∫£o n√∫t n·∫±m tr√™n c√πng */
        transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease; /* Th√™m opacity v√†o transition */
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0.7; /* ƒê·ªô trong su·ªët */
    }
    #musicToggle:hover {
        background-color: var(--music-button-hover-color); /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
        transform: translateY(-2px);
        opacity: 1; /* Hi·ªÉn th·ªã r√µ h∆°n khi hover */
    }
    #musicToggle:active {
        transform: translateY(0);
    }
    #musicToggle.playing::before {
        content: "üéµ"; /* K√Ω t·ª± nh·∫°c */
    }
    #musicToggle.paused::before {
        content: "üîá"; /* K√Ω t·ª± t·∫Øt ti·∫øng */
    }


    .main-content {
      display: flex;
      flex-direction: column; /* M·∫∑c ƒë·ªãnh c·ªôt */
      padding: 30px;
      gap: 30px;
    }

    .left-panel, .right-panel {
      flex: 1;
      padding: 20px;
      border-radius: 10px;
      background: var(--card-bg-color);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .left-panel {
      order: 2; /* ƒê·∫©y xu·ªëng d∆∞·ªõi cho mobile */
    }

    .right-panel {
      order: 1; /* ƒê·∫©y l√™n tr√™n cho mobile */
    }

    /* === Question & Answer Display === */
    #question {
      text-align: center;
      font-size: 1.3em;
      margin-bottom: 25px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dark-text-color);
      background-color: #e9f5f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    .answer-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      font-size: 28px;
      margin-bottom: 30px;
    }

    .answer-group {
      display: flex;
      gap: 5px;
    }

    .letter-box {
      width: 50px;
      height: 50px;
      border: 2px solid var(--primary-color);
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--text-color);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      transition: background-color 0.3s ease;
    }

    .letter-box:not(:empty) {
      background-color: #e0f7fa;
    }
    
    /* === Wheel === */
    #wheel-container {
      position: relative;
      width: 450px;
      height: 450px;
      margin: 0 auto 30px;
      border-radius: 50%;
      box-shadow: 0 0 30px rgba(0,0,0,0.15);
      border: 20px solid var(--primary-color);
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
      transition: transform 5s cubic-bezier(0.33, 1, 0.68, 1);
    }

    .segment {
      position: absolute;
      width: 50%;
      height: 50%;
      top: 0;
      left: 0;
      transform-origin: 100% 100%;
      background-color: #ccc;
      clip-path: polygon(0% 0%, 100% 50%, 0% 100%);
      display: flex;
      align-items: center;
      justify: flex-start;
      font-size: 1.1em;
      font-weight: bold;
      color: white;
      border: 1px solid rgba(0,0,0,0.05);
      box-sizing: border-box;
      padding-left: 15%;
      overflow: hidden;
    }

    .segment span {
      display: block;
      white-space: nowrap;
      transform: rotate(45deg);
      padding-top: 10px;
    }

    #spinButton {
      position: absolute;
      font-size: 32px;
      font-weight: bold;
      color: white;
      background-color: var(--primary-color);
      border: 8px solid #f0f0f0;
      border-radius: 50%;
      width: 130px;
      height: 130px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 10;
      transition: background-color 0.3s ease, transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #spinButton:hover {
      background-color: #bf2a73;
      transform: scale(1.05);
    }

    #spinButton:active {
      transform: scale(0.98);
    }

    #spinButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    #resultOverlay {
      position: absolute;
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      color: white;
      background: rgba(0, 123, 255, 0.95);
      padding: 20px 40px;
      border-radius: 12px;
      z-index: 99;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 150px;
      display: none;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* === Player Scoreboard === */
    #players {
      margin-bottom: 30px;
    }

    .player {
      background: var(--card-bg-color);
      padding: 20px;
      border-radius: 12px;
      border: 3px solid var(--border-color);
      margin-bottom: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .player.active {
      border-color: var(--primary-color);
      background-color: #ffe6f0;
      box-shadow: 0 0 15px rgba(214, 51, 132, 0.4);
      transform: scale(1.03);
    }

    .player h3 {
      margin: 0 0 10px;
      font-size: 1.8em;
      color: var(--text-color);
    }

    .player p {
      font-size: 1.4em;
      font-weight: bold;
      color: var(--primary-color);
      margin: 0;
    }

    /* === Guess Input === */
    #guessInputContainer {
      margin-top: 30px;
      text-align: center;
      display: none;
      background: var(--card-bg-color);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
    }

    #guessInputContainer label {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--dark-text-color);
      margin-bottom: 15px;
      display: block;
    }

    #guessInputContainer input[type="text"] {
      padding: 12px 15px;
      font-size: 1.1em;
      width: calc(100% - 30px);
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    #guessInputContainer input[type="text"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.2);
    }

    #guessInputContainer button {
      padding: 12px 30px;
      font-size: 1.2em;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    #guessInputContainer button:hover {
      background-color: #bf2a73;
      transform: translateY(-2px);
    }

    #guessInputContainer button:active {
      transform: translateY(0);
    }

    .hidden {
      display: none !important;
    }

    /* === Game Notification === */
    #gameNotification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--info-bg-color);
        color: var(--info-text-color);
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        font-size: 1.2em;
        font-weight: bold;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-out, visibility 0.3s ease-out, transform 0.3s ease-out;
        min-width: 250px;
        text-align: center;
    }

    #gameNotification.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }

    /* Notification types */
    #gameNotification.info { background-color: var(--info-bg-color); }
    #gameNotification.success { background-color: var(--success-bg-color); }
    #gameNotification.error { background-color: var(--error-bg-color); }
    #gameNotification.warning { background-color: var(--warning-bg-color); }

    /* === Footer === */
    footer {
        margin-top: 30px; /* Kho·∫£ng c√°ch t·ª´ game-wrapper */
        padding: 15px;
        background-color: var(--primary-color);
        color: white;
        text-align: center;
        font-size: 0.9em;
        border-radius: 8px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1200px; /* ƒê·ªìng b·ªô v·ªõi chi·ªÅu r·ªông game-wrapper */
        box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m tƒÉng width */
    }


    /* === Responsive Design === */
    @media (min-width: 768px) {
      .main-content {
        flex-direction: row;
      }

      .left-panel {
        order: 1;
        width: 65%;
        flex-shrink: 0;
      }

      .right-panel {
        order: 2;
        width: 35%;
        padding-left: 30px;
        flex-shrink: 0;
      }

      #wheel-container {
        width: 500px;
        height: 500px;
      }

      #spinButton {
        width: 150px;
        height: 150px;
        font-size: 36px;
      }

      .letter-box {
        width: 55px;
        height: 55px;
        font-size: 1.6em;
      }
    }

    @media (max-width: 767px) {
        body {
            padding: 10px;
        }
        header h1 {
            font-size: 2em;
        }
        .main-content {
            padding: 15px;
            gap: 15px;
        }
        .left-panel, .right-panel {
            padding: 15px;
        }
        #question {
            font-size: 1.1em;
            margin-bottom: 15px;
            min-height: 45px;
        }
        .answer-container {
            font-size: 20px;
            margin-bottom: 20px;
            gap: 5px;
        }
        .answer-group {
            gap: 3px;
        }
        .letter-box {
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            border-width: 1px;
        }
        #wheel-container {
            width: 300px;
            height: 300px;
            margin-bottom: 20px;
            border-width: 10px;
        }
        #spinButton {
            width: 100px;
            height: 100px;
            font-size: 24px;
            border-width: 5px;
        }
        #resultOverlay {
            font-size: 28px;
            padding: 15px 30px;
            min-width: 100px;
        }
        .player {
            padding: 15px;
            margin-bottom: 15px;
            border-width: 2px;
        }
        .player h3 {
            font-size: 1.5em;
        }
        .player p {
            font-size: 1.2em;
        }
        #guessInputContainer {
            margin-top: 20px;
            padding: 15px;
        }
        #guessInputContainer label {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        #guessInputContainer input[type="text"] {
            padding: 10px;
            font-size: 1em;
            width: calc(100% - 20px);
        }
        #guessInputContainer button {
            padding: 10px 20px;
            font-size: 1.1em;
        }
        /* Footer for mobile */
        footer {
            margin-top: 15px;
            padding: 10px;
            font-size: 0.8em;
        }
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <header>
      <h1>Chi·∫øc N√≥n K·ª≥ Di·ªáu</h1>
    </header>

    <div class="main-content">
      <div class="right-panel">
        <div id="players">
          <div class="player active" id="player1">
            <h3>Ng∆∞·ªùi Ch∆°i</h3>
            <p>ƒêi·ªÉm: <span id="score1">0</span></p>
          </div>
        </div>

        <div id="guessInputContainer">
          <label for="guessLetter" id="guessInputLabel"><strong>Nh·∫≠p k√Ω t·ª±:</strong></label>
          <input type="text" id="guessLetter" maxlength="1" autofocus/>
          <button onclick="submitGuess()">ƒêO√ÅN</button>
        </div>
      </div>

      <div class="left-panel">
        <div id="question"></div>
        <div class="answer-container" id="answerContainer"></div>

        <div id="wheel-container">
          <div id="wheel"></div>
          <button id="spinButton" onclick="spinWheel()">QUAY</button>
          <div id="resultOverlay"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="gameNotification" class="info"></div>
  <button id="musicToggle" class="paused">M·ªü nh·∫°c</button> <footer>
    <p>&copy;2025 - L·ªõp h·ªçc 0 ƒë·ªìng Trung B√¨nh A3</p>
  </footer>

  <audio id="backgroundMusic" loop>
    <source src="nhacnen.mp3" type="audio/mpeg">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph·∫ßn t·ª≠ audio.
  </audio>

  <script src="questions.js"></script>
  <script>
    const segments = [
      { text: "100", color: "#FEEF38" }, // V√†ng
      { text: "200", color: "#FF6B6B" }, // ƒê·ªè nh·∫°t
      { text: "300", color: "#7DE2D1" }, // Xanh ng·ªçc
      { text: "400", color: "#FFD166" }, // Cam nh·∫°t
      { text: "500", color: "#BB86FC" }, // T√≠m
      { text: "600", color: "#00C4B4" }, // Xanh lam
      { text: "700", color: "#A8DADC" }, // Xanh d∆∞∆°ng nh·∫°t
      { text: "800", color: "#EDF5E1" }, // Xanh l√° r·∫•t nh·∫°t
      { text: "900", color: "#FB6F92" }, // H·ªìng ƒë·∫≠m
      { text: "1000", color: "#007BFF" }, // Xanh bi·ªÉn
      { text: "M·∫•t l∆∞·ª£t", color: "#DC3545" }, // ƒê·ªè
      { text: "Nh√¢n ƒë√¥i", color: "#28A745" }, // Xanh l√° c√¢y
      { text: "ƒêo√°n ch·ªØ", color: "#FFC107" }  // V√†ng cam
    ];

    const wheel = document.getElementById("wheel");
    const resultOverlay = document.getElementById("resultOverlay");
    const questionElement = document.getElementById("question");
    const answerContainer = document.getElementById("answerContainer");
    const guessInputContainer = document.getElementById("guessInputContainer");
    const guessInput = document.getElementById("guessLetter");
    const guessInputLabel = document.getElementById("guessInputLabel");
    const guessSubmitBtn = document.querySelector("#guessInputContainer button");
    const gameNotification = document.getElementById("gameNotification");

    const backgroundMusic = document.getElementById("backgroundMusic");
    const musicToggleBtn = document.getElementById("musicToggle");

    let currentQuestionIndex; // Kh√¥ng d√πng bi·∫øn n√†y n·ªØa, thay b·∫±ng questionOrder
    let currentQuestion;
    let answer;
    let plainAnswer;
    let revealedLetters;
    
    let currentPlayer = 1;
    let currentSpinValue = null;
    let scores = [0];
    let currentAngle = 0;
    let spinning = false;

    let isGuessingLetter = false;
    let isGuessingFullAnswer = false;

    // --- Bi·∫øn m·ªõi cho vi·ªác ch·ªçn c√¢u h·ªèi ng·∫´u nhi√™n v√† kh√¥ng l·∫∑p l·∫°i ---
    let availableQuestionIndices = []; // L∆∞u tr·ªØ c√°c ch·ªâ s·ªë c√¢u h·ªèi c√≤n l·∫°i
    let askedQuestionIndices = []; // L∆∞u tr·ªØ c√°c ch·ªâ s·ªë c√¢u h·ªèi ƒë√£ h·ªèi

    // --- Ch·ª©c nƒÉng nh·∫°c n·ªÅn ---
    let isMusicPlaying = false; 
    let hasUserInteracted = false; // Bi·∫øn m·ªõi ƒë·ªÉ theo d√µi t∆∞∆°ng t√°c ng∆∞·ªùi d√πng

    function toggleMusic() {
        // N·∫øu ƒë√¢y l√† l·∫ßn t∆∞∆°ng t√°c ƒë·∫ßu ti√™n v·ªõi n√∫t nh·∫°c v√† nh·∫°c ƒëang t·∫Øt
        if (!hasUserInteracted && !isMusicPlaying) {
            backgroundMusic.volume = 0.5; // ƒê·∫∑t √¢m l∆∞·ª£ng
            backgroundMusic.play().then(() => {
                isMusicPlaying = true;
                hasUserInteracted = true; // ƒê√°nh d·∫•u ƒë√£ c√≥ t∆∞∆°ng t√°c
                musicToggleBtn.classList.remove('paused');
                musicToggleBtn.classList.add('playing');
                musicToggleBtn.textContent = 'T·∫Øt nh·∫°c';
            }).catch(e => {
                console.warn("L·ªói khi c·ªë g·∫Øng ph√°t nh·∫°c l·∫ßn ƒë·∫ßu qua n√∫t:", e);
                showNotification("Tr√¨nh duy·ªát ch·∫∑n t·ª± ƒë·ªông ph√°t nh·∫°c. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c cho ph√©p ph√°t media.", 5000, 'error');
                // Gi·ªØ nguy√™n tr·∫°ng th√°i n√∫t n·∫øu ph√°t kh√¥ng th√†nh c√¥ng
            });
        } else {
            // N·∫øu nh·∫°c ƒëang ph√°t, th√¨ t·∫°m d·ª´ng
            if (isMusicPlaying) {
                backgroundMusic.pause();
                musicToggleBtn.classList.remove('playing');
                musicToggleBtn.classList.add('paused');
                musicToggleBtn.textContent = 'M·ªü nh·∫°c';
                isMusicPlaying = false;
            } else { // N·∫øu nh·∫°c ƒëang t·∫Øt, th√¨ ph√°t
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    musicToggleBtn.classList.remove('paused');
                    musicToggleBtn.classList.add('playing');
                    musicToggleBtn.textContent = 'T·∫Øt nh·∫°c';
                }).catch(e => {
                    console.warn("L·ªói khi c·ªë g·∫Øng ph√°t nh·∫°c qua n√∫t:", e);
                    showNotification("Kh√¥ng th·ªÉ ph√°t nh·∫°c. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t tr√¨nh duy·ªát.", 5000, 'error');
                });
            }
        }
    }

    musicToggleBtn.addEventListener('click', toggleMusic);

    // --- K·∫øt th√∫c ch·ª©c nƒÉng nh·∫°c n·ªÅn ---

    function showNotification(message, duration = 3000, type = 'info') {
        if (gameNotification.timeoutId) {
            clearTimeout(gameNotification.timeoutId);
        }

        gameNotification.textContent = message;
        gameNotification.className = `info ${type}`;
        gameNotification.classList.add('show');

        gameNotification.timeoutId = setTimeout(() => {
            gameNotification.classList.remove('show');
            gameNotification.addEventListener('transitionend', function handler() {
                gameNotification.className = 'info';
                gameNotification.removeEventListener('transitionend', handler);
            }, { once: true });
        }, duration);
    }

    // --- H√†m m·ªõi ƒë·ªÉ l·∫•y c√¢u h·ªèi ng·∫´u nhi√™n kh√¥ng l·∫∑p l·∫°i ---
    function getRandomQuestionIndex() {
        if (availableQuestionIndices.length === 0) {
            // N·∫øu ƒë√£ h·ªèi h·∫øt t·∫•t c·∫£ c√°c c√¢u, c√≥ th·ªÉ reset l·∫°i ho·∫∑c k·∫øt th√∫c tr√≤ ch∆°i
            return -1; // ƒê√°nh d·∫•u ƒë√£ h·∫øt c√¢u h·ªèi
        }
        const randomIndex = Math.floor(Math.random() * availableQuestionIndices.length);
        const questionActualIndex = availableQuestionIndices.splice(randomIndex, 1)[0]; // L·∫•y v√† lo·∫°i b·ªè kh·ªèi danh s√°ch
        askedQuestionIndices.push(questionActualIndex); // Th√™m v√†o danh s√°ch ƒë√£ h·ªèi
        return questionActualIndex;
    }

    function initializeGame() {
      if (availableQuestionIndices.length === 0 && askedQuestionIndices.length === 0) {
          // L·∫ßn ƒë·∫ßu ti√™n ch·∫°y ho·∫∑c ƒë√£ ch∆°i xong h·∫øt c√°c c√¢u tr∆∞·ªõc ƒë√≥
          for (let i = 0; i < allQuestions.length; i++) {
              availableQuestionIndices.push(i);
          }
          // X√°o tr·ªôn availableQuestionIndices n·∫øu mu·ªën (t√πy ch·ªçn)
          // availableQuestionIndices.sort(() => Math.random() - 0.5); 
      }

      const nextQuestionActualIndex = getRandomQuestionIndex();

      if (nextQuestionActualIndex === -1) {
        endGame();
        return;
      }

      currentQuestion = allQuestions[nextQuestionActualIndex];
      answer = currentQuestion.answer;
      plainAnswer = currentQuestion.plainAnswer;
      revealedLetters = Array(answer.length).fill(null);

      answer.forEach((char, index) => {
        if (char === " ") {
          revealedLetters[index] = char;
        }
      });

      questionElement.innerHTML = `<strong>C√¢u h·ªèi:</strong> ${currentQuestion.question}`;
      renderAnswerBoxes();
      renderWheelSegments();
      updateScores();
      document.getElementById("spinButton").disabled = false;
      guessInputContainer.style.display = "none";
      resultOverlay.style.display = "none";

      document.getElementById("player1").classList.add("active");
      showNotification(`B·∫Øt ƒë·∫ßu c√¢u h·ªèi m·ªõi (${askedQuestionIndices.length}/${allQuestions.length})! ƒê·∫øn l∆∞·ª£t b·∫°n quay n√≥n.`);
    }

    function renderAnswerBoxes() {
      answerContainer.innerHTML = '';
      let currentGroup = document.createElement("div");
      currentGroup.className = "answer-group";

      answer.forEach((char, index) => {
        if (char === " ") {
          answerContainer.appendChild(currentGroup);
          const spaceDiv = document.createElement("div");
          spaceDiv.style.width = "20px";
          answerContainer.appendChild(spaceDiv);
          currentGroup = document.createElement("div");
          currentGroup.className = "answer-group";
        } else {
          const box = document.createElement("div");
          box.className = "letter-box";
          box.id = `box-${index}`;
          box.innerText = revealedLetters[index] || '';
          currentGroup.appendChild(box);
        }
      });
      if (currentGroup.children.length > 0) {
        answerContainer.appendChild(currentGroup);
      }
    }

    function renderWheelSegments() {
      wheel.innerHTML = '';
      const numSegments = segments.length;
      const anglePerSegment = 360 / numSegments;

      segments.forEach((seg, i) => {
        const segmentDiv = document.createElement("div");
        segmentDiv.className = "segment";
        segmentDiv.style.backgroundColor = seg.color;
        
        const skewYValue = 90 - (anglePerSegment / 2);
        segmentDiv.style.transform = `rotate(${i * anglePerSegment}deg) skewY(${skewYValue}deg)`;
        segmentDiv.style.clipPath = `polygon(0% 0%, 100% 50%, 0% 100%)`;

        const textSpan = document.createElement("span");
        textSpan.innerText = seg.text;
        textSpan.style.transform = `skewY(-${skewYValue}deg) rotate(${anglePerSegment / 2}deg)`;
        segmentDiv.appendChild(textSpan);
        wheel.appendChild(segmentDiv);
      });
    }

    function spinWheel() {
      if (spinning) return;
      spinning = true;
      document.getElementById("spinButton").disabled = true;
      resultOverlay.style.display = "none";
      guessInputContainer.style.display = "none";

      // Ph√°t nh·∫°c ngay khi nh·∫•n n√∫t quay l·∫ßn ƒë·∫ßu ti√™n
      if (!hasUserInteracted && !isMusicPlaying) {
          backgroundMusic.volume = 0.5; // ƒê·∫∑t √¢m l∆∞·ª£ng
          backgroundMusic.play().then(() => {
              isMusicPlaying = true;
              hasUserInteracted = true; // ƒê√°nh d·∫•u ƒë√£ c√≥ t∆∞∆°ng t√°c
              musicToggleBtn.classList.remove('paused');
              musicToggleBtn.classList.add('playing');
              musicToggleBtn.textContent = 'T·∫Øt nh·∫°c';
              showNotification("Nh·∫°c ƒë√£ ƒë∆∞·ª£c b·∫≠t!", 2000, 'success');
          }).catch(e => {
              console.warn("L·ªói khi c·ªë g·∫Øng ph√°t nh·∫°c l·∫ßn ƒë·∫ßu qua n√∫t quay:", e);
              showNotification("Tr√¨nh duy·ªát ch·∫∑n t·ª± ƒë·ªông ph√°t nh·∫°c. Vui l√≤ng nh·∫•n n√∫t 'M·ªü nh·∫°c' ·ªü g√≥c d∆∞·ªõi ƒë·ªÉ b·∫≠t.", 5000, 'error');
              // Gi·ªØ nguy√™n tr·∫°ng th√°i n√∫t n·∫øu ph√°t kh√¥ng th√†nh c√¥ng
          });
      }


      const spinDegree = 3600 + Math.floor(Math.random() * 360);
      currentAngle += spinDegree;
      wheel.style.transition = "transform 5s cubic-bezier(0.33, 1, 0.68, 1)";
      wheel.style.transform = `rotate(${currentAngle}deg)`;

      setTimeout(() => {
        const finalAngle = currentAngle % 360;
        const index = Math.floor((360 - (finalAngle % 360)) / (360 / segments.length)) % segments.length;
        const result = segments[index].text;

        resultOverlay.innerText = result;
        resultOverlay.style.background = segments[index].color;
        resultOverlay.style.display = "block";

        if (!isNaN(parseInt(result))) {
          currentSpinValue = parseInt(result);
          isGuessingLetter = true;
          isGuessingFullAnswer = false;
          updateGuessInputVisibility();
          showNotification(`K·∫øt qu·∫£: +${result}! Nh·∫≠p ch·ªØ c√°i b·∫°n mu·ªën ƒëo√°n.`, 3000, 'info');
        } else if (result === "Nh√¢n ƒë√¥i") {
          currentSpinValue = "double";
          isGuessingLetter = true;
          isGuessingFullAnswer = false;
          updateGuessInputVisibility();
          showNotification(`K·∫øt qu·∫£: Nh√¢n ƒë√¥i! Nh·∫≠p ch·ªØ c√°i b·∫°n mu·ªën ƒëo√°n.`, 3000, 'info');
        } else if (result === "ƒêo√°n ch·ªØ") {
          isGuessingLetter = false;
          isGuessingFullAnswer = true;
          updateGuessInputVisibility();
          showNotification(`K·∫øt qu·∫£: ƒêo√°n ch·ªØ! Nh·∫≠p to√†n b·ªô ƒë√°p √°n.`, 3000, 'info');
        } else { // M·∫•t l∆∞·ª£t
          currentSpinValue = null;
          isGuessingLetter = false;
          isGuessingFullAnswer = false;
          scores[0] -= 300;
          if (scores[0] < 0) scores[0] = 0;
          updateScores();
          showNotification(`${result}! B·∫°n b·ªã tr·ª´ 300 ƒëi·ªÉm.`, 3000, 'warning');
          document.getElementById("spinButton").disabled = false;
          setTimeout(() => { resultOverlay.style.display = "none"; }, 1500);
        }

        spinning = false;

        if (isGuessingLetter || isGuessingFullAnswer) {
            setTimeout(() => { resultOverlay.style.display = "none"; }, 1500);
        }

      }, 5000);
    }

    function updateGuessInputVisibility() {
      guessInputContainer.style.display = "block";
      guessInput.value = "";
      guessInput.focus();

      if (isGuessingLetter) {
        guessInputLabel.innerText = "Nh·∫≠p k√Ω t·ª± (1 ch·ªØ):";
        guessInput.maxLength = "1"; // Gi·ªõi h·∫°n 1 k√Ω t·ª±
        guessInput.placeholder = "Nh·∫≠p m·ªôt ch·ªØ c√°i...";
        guessSubmitBtn.innerText = "ƒêO√ÅN CH·ªÆ";
      } else if (isGuessingFullAnswer) {
        guessInputLabel.innerText = "Nh·∫≠p to√†n b·ªô ƒë√°p √°n:";
        guessInput.removeAttribute("maxlength"); // X√≥a b·ªè gi·ªõi h·∫°n maxlength
        guessInput.placeholder = "Nh·∫≠p to√†n b·ªô ƒë√°p √°n...";
        guessSubmitBtn.innerText = "ƒêO√ÅN TO√ÄN B·ªò";
      } else {
        guessInputContainer.style.display = "none";
      }
    }

    function submitGuess() {
      const guess = guessInput.value.toUpperCase().trim();
      if (!guess) {
        showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung ƒëo√°n.', 3000, 'warning');
        return;
      }

      if (isGuessingLetter) {
        if (guess.length !== 1) {
            showNotification('Vui l√≤ng ch·ªâ nh·∫≠p 1 k√Ω t·ª± ƒë·ªÉ ƒëo√°n ch·ªØ c√°i.', 3000, 'warning');
            return;
        }
        processLetterGuess(guess);
      } else if (isGuessingFullAnswer) {
        processFullAnswerGuess(guess);
      }
      
      guessInputContainer.style.display = "none";
      document.getElementById("spinButton").disabled = false;
    }

    function processLetterGuess(letter) {
      const inputPlain = letter.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      let matched = 0;
      
      for (let i = 0; i < plainAnswer.length; i++) {
        if (plainAnswer[i] === inputPlain && revealedLetters[i] === null) {
          revealedLetters[i] = answer[i];
          document.getElementById(`box-${i}`).innerText = answer[i];
          matched++;
        }
      }

      if (matched > 0) {
        let earned = 0;
        if (currentSpinValue === "double") {
          earned = matched * 2 * 200; // Gi·∫£ s·ª≠ "Nh√¢n ƒë√¥i" s·∫Ω x2 ƒëi·ªÉm c∆° b·∫£n (200)
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng ${matched} ch·ªØ. ƒê∆∞·ª£c x2 ƒëi·ªÉm, nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success');
        } else {
          earned = matched * currentSpinValue;
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng ${matched} ch·ªØ. Nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success');
        }
        scores[0] += earned;
      } else {
        scores[0] -= 300;
        if (scores[0] < 0) scores[0] = 0;
        showNotification(`Sai r·ªìi! B·∫°n ƒëo√°n ch·ªØ '${letter}' kh√¥ng c√≥ ho·∫∑c ƒë√£ m·ªü. B·ªã tr·ª´ 300 ƒëi·ªÉm.`, 3000, 'error');
      }
      updateScores();
      isGuessingLetter = false;
      checkGameCompletion();
    }

    function processFullAnswerGuess(guess) {
      // Chuy·ªÉn ƒë·ªïi c·∫£ ƒëo√°n c·ªßa ng∆∞·ªùi d√πng v√† ƒë√°p √°n ƒë√∫ng v·ªÅ d·∫°ng kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng ƒë·ªÉ so s√°nh
      const normalizedGuess = guess.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '');
      const normalizedCorrectAnswer = plainAnswer.filter(char => char !== " ").join("");

      if (normalizedGuess === normalizedCorrectAnswer) {
          const hiddenLettersCount = revealedLetters.filter(l => l === null).length;
          let earned = hiddenLettersCount * 100; // Th∆∞·ªüng 100 ƒëi·ªÉm cho m·ªói ch·ªØ c√°i ch∆∞a m·ªü
          scores[0] += earned;
          
          // M·ªü t·∫•t c·∫£ c√°c ch·ªØ c√°i c√≤n l·∫°i
          for (let i = 0; i < answer.length; i++) {
              if (revealedLetters[i] === null) {
                  revealedLetters[i] = answer[i];
                  document.getElementById(`box-${i}`).innerText = answer[i];
              }
          }
          showNotification(`Ch√≠nh x√°c! B·∫°n ƒëo√°n ƒë√∫ng to√†n b·ªô ƒë√°p √°n. Nh·∫≠n +${earned} ƒëi·ªÉm.`, 3000, 'success');
          updateScores();
          checkGameCompletion();
      } else {
          scores[0] -= 300;
          if (scores[0] < 0) scores[0] = 0;
          showNotification(`Sai r·ªìi! B·∫°n ƒëo√°n sai to√†n b·ªô ƒë√°p √°n. B·ªã tr·ª´ 300 ƒëi·ªÉm.`, 3000, 'error');
      }
      updateScores();
      isGuessingFullAnswer = false;
    }

    function updateScores() {
      document.getElementById("score1").innerText = scores[0];
    }

    function checkGameCompletion() {
      const allLetterBoxesFilled = revealedLetters.every(char => char !== null);

      if (allLetterBoxesFilled) {
        showNotification("T·∫•t c·∫£ c√°c √¥ ƒë√£ ƒë∆∞·ª£c m·ªü! Chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo.", 3000, 'info');
        setTimeout(() => {
          initializeGame(); // G·ªçi l·∫°i ƒë·ªÉ l·∫•y c√¢u h·ªèi m·ªõi
        }, 10000); 
      }
    }

    function endGame() {
      const finalScore = scores[0];
      
      document.getElementById("player1").classList.remove("active");
      document.querySelector("#player1 h3").innerText = "Tr√≤ ch∆°i k·∫øt th√∫c!";
      document.querySelector("#player1 p").innerText = "ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n: " + finalScore;
      
      document.getElementById("spinButton").disabled = true;
      guessInputContainer.style.display = "none";
      resultOverlay.style.display = "none";
      showNotification("Tr√≤ ch∆°i ƒë√£ k·∫øt th√∫c! T·ªïng ƒëi·ªÉm c·ªßa b·∫°n l√†: " + finalScore + ". C·∫£m ∆°n b·∫°n ƒë√£ tham gia.", 5000, 'info');
    }

    // Kh·ªüi t·∫°o tr√≤ ch∆°i l·∫ßn ƒë·∫ßu
    initializeGame();
  </script>
</body>
</html>
